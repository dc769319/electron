From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Milan Burda <miburda@microsoft.com>
Date: Tue, 16 Apr 2019 10:54:11 +0200
Subject: Launch child processes in a job to ensure that they don't outlive the
 browser

Backports:
- https://chromium-review.googlesource.com/c/chromium/src/+/1350977
- https://chromium-review.googlesource.com/c/chromium/src/+/1548839

diff --git a/services/service_manager/sandbox/win/sandbox_win.cc b/services/service_manager/sandbox/win/sandbox_win.cc
index 7beb41460e7d1a7340cca8ebc98a114ec41b3e44..3bbafed63476f48f95e63e4df999598e88e6dd95 100644
--- a/services/service_manager/sandbox/win/sandbox_win.cc
+++ b/services/service_manager/sandbox/win/sandbox_win.cc
@@ -831,10 +831,14 @@ sandbox::ResultCode SandboxWin::StartSandboxedProcess(
           service_manager::switches::kNoSandbox)) {
     base::LaunchOptions options;
     options.handles_to_inherit = handles_to_inherit;
-    if (sandbox_type == SANDBOX_TYPE_NETWORK) {
-      // Launch the process in a job to ensure that the network process doesn't
-      // outlive the browser. This could happen if there is a lot of I/O on
-      // process shutdown, in which case TerminateProcess would fail.
+    BOOL in_job = true;
+    // Prior to Windows 8 nested jobs aren't possible.
+    if (base::win::GetVersion() >= base::win::VERSION_WIN8 ||
+        (::IsProcessInJob(::GetCurrentProcess(), nullptr, &in_job) &&
+         !in_job)) {
+      // Launch the process in a job to ensure that it doesn't outlive the
+      // browser. This could happen if there is a lot of I/O on process
+      // shutdown, in which case TerminateProcess would fail.
       // https://crbug.com/820996
       if (!g_job_object_handle) {
         sandbox::Job job_obj;
